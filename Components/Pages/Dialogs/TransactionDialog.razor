@using ExpenseTracker.Database.Models
@using ExpenseTracker.Services
@inject TransactionService TransactionService

<MudDialog>
    <TitleContent>
        Transaction
    </TitleContent>
    <DialogContent>
        <MudForm @ref="form" @bind-IsValid="@success" @bind-Errors="@errors">
            <div style="display: flex; flex-direction: column; gap: 1rem; min-width: 350px;">
                <MudSelect @bind-Value="Transaction.Type" Label="Type" Required="true"
                    RequiredError="Type of transaction is required!">
                    @foreach (TransactionType item in Enum.GetValues(typeof(TransactionType)))
                    {
                        <MudSelectItem Value="@item">@item</MudSelectItem>
                    }
                </MudSelect>
                <MudNumericField @bind-Value="Transaction.Amount" Label="Amount" Variant="Variant.Text" Required="true"
                    RequiredError="Amount is required!">
                </MudNumericField>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <MudDatePicker Label="Date" @bind-Date="_date" Required="true" RequiredError="Date is required!" />
                    <MudTimePicker Label="Time" AmPm="true" @bind-Time="_time" RequiredError="Time is required!" />
                </div>
                <MudTextField @bind-Value="Transaction.Description" Label="Description" Variant="Variant.Text">
                </MudTextField>
            </div>
        </MudForm>

    </DialogContent>
    <DialogActions>
        <div style="display: flex; flex-direction: row; gap: 1rem;">
            <MudButton Color="Color.Primary" OnClick="Submit">Save</MudButton>
            <MudButton OnClick="Cancel">Cancel</MudButton>
        </div>
    </DialogActions>
</MudDialog>

@code {
    bool success;
    string[] errors = { };
    MudForm form;

    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; }

    [Parameter]
    public int? TransactionId { get; set; }

    private DateTime? _date;
    private TimeSpan? _time;
    private Transaction Transaction = new Transaction();
    protected override async Task OnInitializedAsync()
    {
        if (TransactionId == null)
        {
            Transaction = new Transaction();
            Transaction.Type = TransactionType.Expense;
            Transaction.Date = DateTime.Now;
            _date = DateTime.Today;
            _time = DateTime.Now.TimeOfDay;
            return;

        }
        Transaction? t = await TransactionService.GetAsync((int)TransactionId);
        if(t == null){
            MudDialog.Close();
            return;
        }

        Transaction = t;
        _date = Transaction.Date.Date;
        _time = Transaction.Date.TimeOfDay;
    }


    private async void Submit()
    {
        await form.Validate();
        if (!form.IsValid)
        {
            return;
        }

        // since we validate first
        // we know that _date and _time have values
        Transaction.Date = (DateTime)(_date + _time);
        
        await TransactionService.Save(Transaction);
        MudDialog.Close(DialogResult.Ok(result: true));
    }

    private void Cancel() => MudDialog.Cancel();
}